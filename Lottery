import random
from datetime import datetime
import tkinter as tk
from tkinter import messagebox
import requests
from bs4 import BeautifulSoup
from PIL import Image, ImageTk
import io
import sys
import os

# æŠ½å¥–æ¦‚ç‡é…ç½® (æ€»å’Œåº”è¯¥ä¸º100)
lottery_items = [
    ("æ»šä½ å¦ˆçš„", 2.5),
    ("å»ä½ å¦ˆçš„", 2.5),
    ("ä½ ä¹Ÿé…ï¼Ÿ", 2.5),
    ("å‚»é€¼äºŒæ¬¡å…ƒ", 1.5),
    ("ç™”ç—‡åˆçŠ¯äº†ï¼Ÿ", 2.5),
    ("æ­»ç”·åŒçœŸæ¶å¿ƒ", 2.5),
    ("ç°åœ¨æ˜¯å¹»æƒ³æ—¶åˆ»", 1.5),
    ("æŸšå­å¨æ»šå‡ºå»", 2.5),
    ("è¿™æ˜¯æœ€åé€šç‰’", 2.5),
    ("ä»¥åä¸è¦å†å’Œæˆ‘æ‰¯ä¸Šå…³ç³»", 2.5),
    ("è¢«æ‹‰é»‘+å±è”½", 1.5),
    ("å°ç”·å¨˜", 1.5),
    ("éšæœºçš„ç½‘å›¾", 32),
    ("éšæœºçš„è´´å§åœ£ç»", 32),
    ("ä¸‹æ¬¡å†è¯´å§", 2.5),
    ("ä½ æ˜¯ä¸ªå¥½äºº", 2.5),
    ("æˆ‘ä¸€ç›´æŠŠä½ å½“å¥½æœ‹å‹", 2.5),
    ("æ»šå‡ºå»", 2.49),
    ("å¥½å‘€å®å®", 0.01)
]

# æ´»åŠ¨ç»“æŸæ—¥æœŸ
END_DATE = datetime(2025, 8, 29)

# è·å–æ–‡ä»¶è·¯å¾„ï¼ˆæ‰“åŒ…å‰ç”¨å½“å‰ç›®å½•ï¼Œæ‰“åŒ…åç”¨ä¸´æ—¶ç›®å½•ï¼‰
def get_resource_path(relative_path):
    if hasattr(sys, '_MEIPASS'):
        # æ‰“åŒ…åçš„è·¯å¾„ï¼ˆexeè¿è¡Œæ—¶ä¼šè§£å‹åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼‰
        return os.path.join(sys._MEIPASS, relative_path)
    # æ‰“åŒ…å‰çš„è·¯å¾„ï¼ˆå¼€å‘æ—¶ï¼‰
    return os.path.join(os.path.abspath("."), relative_path)


# ç½‘å›¾ç´ ææ± 
def load_net_images(filepath="net_images.txt"):
    path = get_resource_path(filepath)
    try:
        with open(path, "r", encoding="utf-8") as f:
            return [line.strip() for line in f if line.strip()]
    except Exception as e:
        print("ç½‘å›¾æ–‡ä»¶è¯»å–å¤±è´¥:", e)
        return []

# è´´å§åœ£ç»ç´ ææ± ï¼ˆä»æ–‡ä»¶è¯»å–ï¼‰
def load_tieba_quotes(filepath="tieba_quotes.txt"):
    path = get_resource_path(filepath)
    try:
        with open(path, "r", encoding="utf-8") as f:
            content = f.read()
            segments = []
            for seg in content.split('\n\n'):
                seg = seg.strip()
                if seg:
                    segments.append(seg)
            return segments
    except Exception as e:
        print("è´´å§åœ£ç»æ–‡ä»¶è¯»å–å¤±è´¥:", e)
        return []

net_images = load_net_images()
tieba_quotes = load_tieba_quotes()

# æ„å»ºæ¦‚ç‡åˆ—è¡¨
def build_probability_list(items):
    prob_list = []
    for item, prob in items:
        # æ‰©å¤§100å€å¤„ç†å°æ•°æ¦‚ç‡
        count = int(prob * 100)
        prob_list.extend([item] * count)
    return prob_list

probability_list = build_probability_list(lottery_items)

def lottery():
    now = datetime.now()
    if now > END_DATE:
        return f"ğŸ‰ä¸ƒå¤•é™å®šå¡æ± å·²ç»“æŸğŸ’”\næ´»åŠ¨å·²äº{END_DATE.strftime('%Yå¹´%mæœˆ%dæ—¥')}ç»“æŸï¼Œæ„Ÿè°¢å‚ä¸ï¼"
    result = random.choice(probability_list)
    if result == "å¥½å‘€å®å®":
        return f"ğŸ’˜æ­å–œä½ æŠ½ä¸­é™å®šSSRã€Œ{result}ã€ğŸ’•\nä½ æ˜¯å¤©é€‰ä¹‹å­ï¼"
    elif result == "éšæœºçš„ç½‘å›¾":
        img_url = random.choice(net_images) if net_images else "æš‚æ— ç½‘å›¾ç´ æ"
        return f"ğŸ°ä½ çš„æŠ½ç­¾ç»“æœæ˜¯ï¼šã€Œ{result}ã€\néšæœºç½‘å›¾ï¼š{img_url}"
    elif result == "éšæœºçš„è´´å§åœ£ç»":
        quote = random.choice(tieba_quotes) if tieba_quotes else "æš‚æ— åœ£ç»ç´ æ"
        return f"ğŸ°ä½ çš„æŠ½ç­¾ç»“æœæ˜¯ï¼šã€Œ{result}ã€\n {quote}"
    else:
        return f"ğŸ°ä½ çš„æŠ½ç­¾ç»“æœæ˜¯ï¼šã€Œ{result}ã€\nç»§ç»­åŠªåŠ›ï¼Œä¸‹ä¸€æ¬¡å¯èƒ½ä¼šæŠ½åˆ°é™å®šSSRå“¦ï¼"

img_win_global = None  # ä¿å­˜å½“å‰å›¾ç‰‡çª—å£

def handle_lottery_gui():
    global img_win_global
    # å¦‚æœæœ‰æ—§å›¾ç‰‡çª—å£ï¼Œå…ˆå…³é—­
    if img_win_global is not None and img_win_global.winfo_exists():
        img_win_global.destroy()
        img_win_global = None

    result = lottery()
    if result.startswith("ğŸ°ä½ çš„æŠ½ç­¾ç»“æœæ˜¯ï¼šã€Œéšæœºçš„ç½‘å›¾ã€"):
        # æå–å›¾ç‰‡é“¾æ¥
        img_url = result.split("éšæœºç½‘å›¾ï¼š")[-1].strip()
        try:
            resp = requests.get(img_url, timeout=5)
            img_data = resp.content
            img = Image.open(io.BytesIO(img_data))
            img = img.resize((300, 300))  # å¯æ ¹æ®éœ€è¦è°ƒæ•´å¤§å°
            img_tk = ImageTk.PhotoImage(img)
            img_win = tk.Toplevel()
            img_win.title("æŠ½å¥–ç»“æœ")
            tk.Label(img_win, text="ä½ çš„æŠ½ç­¾ç»“æœæ˜¯ï¼š", font=("æ€æºé»‘ä½“", 12)).pack(pady=10)
            tk.Label(img_win, image=img_tk).pack(pady=10)
            img_win.img_tk = img_tk  # é˜²æ­¢è¢«åƒåœ¾å›æ”¶
            # å¢åŠ ç¡®å®šæŒ‰é’®
            tk.Button(img_win, text="ç¡®å®š", font=("æ€æºé»‘ä½“", 12), command=img_win.destroy).pack(pady=10)
            img_win_global = img_win
        except Exception as e:
            messagebox.showinfo("æŠ½å¥–ç»“æœ", f"å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š{e}\n{result}")
    else:
        messagebox.showinfo("æŠ½å¥–ç»“æœ", result)

if __name__ == "__main__":
    # åˆ›å»ºçª—å£
    root = tk.Tk()
    root.title("æŠ½å¥–ç¨‹åº")
    root.geometry("300x150")

    label = tk.Label(root, text="ç‚¹å‡»æŒ‰é’®è¿›è¡ŒæŠ½å¥–", font=("æ€æºé»‘ä½“", 12))
    label.pack(pady=20)

    button = tk.Button(root, text="å’±ä¿©è¯•è¯•ï¼Ÿ", font=("æ€æºé»‘ä½“", 12), command = handle_lottery_gui)
    button.pack(pady=10)
    handle_lottery_gui()
    
    root.mainloop()
    button.pack(pady=10)
    handle_lottery_gui()
    
    root.mainloop()

